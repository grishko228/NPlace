<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NPLACE ‚Äî —Ç–≤–æ–π —Ö–æ–ª—Å—Ç</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 10px; background: #f0f0f0; }
    h1 { margin-bottom: 0.2em; }
    #auth { margin-bottom: 15px; }
    #login, #logout { padding: 8px 15px; font-size: 14px; cursor: pointer; }
    #logout { display: none; }
    #user-info { margin-left: 10px; display: inline-block; font-weight: bold; }
    #nickname-section { margin-bottom: 20px; }
    #nickname { width: 200px; padding: 6px; font-size: 14px; }
    #saveNick { padding: 6px 12px; margin-left: 6px; cursor: pointer; }
    #leaderboard { background: white; padding: 10px; border-radius: 5px; max-width: 300px; }
    .top-player { padding: 4px 0; border-bottom: 1px solid #ddd; }
    .top-player:last-child { border-bottom: none; }
    #canvas-container { position: relative; margin-top: 20px; }
    canvas { background: white; border: 1px solid #aaa; image-rendering: pixelated; }
    #scaleControl { margin-top: 10px; }
    .owner-label { color: green; font-weight: bold; margin-left: 8px; }
  </style>
</head>
<body>
  <h1>NPLACE</h1>

  <div id="auth">
    <button id="login">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    <button id="logout">–í—ã–π—Ç–∏</button>
    <span id="user-info"></span>
  </div>

  <div id="nickname-section">
    <label for="nickname">–ù–∏–∫: </label>
    <input type="text" id="nickname" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫" />
    <button id="saveNick">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <span id="ownerLabel" class="owner-label" style="display:none;">üëë –í–ª–∞–¥–µ–ª–µ—Ü</span>
  </div>

  <h2>üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h2>
  <div id="leaderboard">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

  <div id="canvas-container">
    <canvas id="canvas" width="50" height="50"></canvas>
  </div>

  <div id="scaleControl">
    –ú–∞—Å—à—Ç–∞–±: 
    <button data-scale="1">1x</button>
    <button data-scale="2">2x</button>
    <button data-scale="4">4x</button>
    <button data-scale="8">8x</button>
  </div>

  <script>
    // ‚Äî‚Äî‚Äî –ö–æ–Ω—Ñ–∏–≥ Firebase ‚Äî‚Äî‚Äî
    const firebaseConfig = {
      apiKey: "AIzaSyCVwOQaTPRrDz3dC98Tyg3ByW0JbyNLMJY",
      authDomain: "analox-wplase.firebaseapp.com",
      databaseURL: "https://analox-wplase-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "analox-wplase",
      storageBucket: "analox-wplase.appspot.com",
      messagingSenderId: "839969323587",
      appId: "1:839969323587:web:3c476167862cac9d32b2f6"
    };

    // ‚Äî‚Äî‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase ‚Äî‚Äî‚Äî
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // ‚Äî‚Äî‚Äî DOM ‚Äî‚Äî‚Äî
    const loginBtn = document.getElementById('login');
    const logoutBtn = document.getElementById('logout');
    const userInfo = document.getElementById('user-info');
    const nicknameInput = document.getElementById('nickname');
    const saveNickBtn = document.getElementById('saveNick');
    const ownerLabel = document.getElementById('ownerLabel');
    const leaderboardDiv = document.getElementById('leaderboard');

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // ‚Äî‚Äî‚Äî –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ‚Äî‚Äî‚Äî
    let currentUser = null;
    let currentUID = null;
    const OWNER_UID = "—Ç–≤–æ—è_—Ñ–∏—Ä–µ–±–µ–π—Å_uid_—Å—é–¥–∞_–≤—Å—Ç–∞–≤—å"; // <---- —Å—é–¥–∞ —Å–≤–æ–π uid –≤—Å—Ç–∞–≤—å

    // ‚Äî‚Äî‚Äî –ú–∞—Å—à—Ç–∞–± ‚Äî‚Äî‚Äî
    let scale = 8;
    const baseCanvasSize = 50;

    // ‚Äî‚Äî‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∞ canvas ‚Äî‚Äî‚Äî
    function resizeCanvas() {
      canvas.style.width = baseCanvasSize * scale + 'px';
      canvas.style.height = baseCanvasSize * scale + 'px';
      drawGrid();
      loadPixels();
    }

    // ‚Äî‚Äî‚Äî –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ—Ç–∫–∏ ‚Äî‚Äî‚Äî
    function drawGrid() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // –†–∏—Å—É–µ–º –∫–∞–∂–¥—ã–π –ø–∏–∫—Å–µ–ª—å
      db.ref('pixels').once('value').then(snapshot => {
        snapshot.forEach(childSnap => {
          const pixel = childSnap.val();
          if(pixel.x !== undefined && pixel.y !== undefined && pixel.color) {
            ctx.fillStyle = pixel.color;
            ctx.fillRect(pixel.x, pixel.y, 1, 1);
          }
        });
      }).then(() => {
        // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É
        ctx.strokeStyle = '#ccc';
        ctx.lineWidth = 0.1;
        for(let i=0; i<=canvas.width; i++) {
          ctx.beginPath();
          ctx.moveTo(i,0);
          ctx.lineTo(i,canvas.height);
          ctx.stroke();
        }
        for(let j=0; j<=canvas.height; j++) {
          ctx.beginPath();
          ctx.moveTo(0,j);
          ctx.lineTo(canvas.width,j);
          ctx.stroke();
        }
      });
    }

    // ‚Äî‚Äî‚Äî –ó–∞–≥—Ä—É–∑–∫–∞ –ø–∏–∫—Å–µ–ª–µ–π ‚Äî‚Äî‚Äî
    function loadPixels() {
      // –°–µ–π—á–∞—Å –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º (—á–µ—Ä–µ–∑ drawGrid)
    }

    // ‚Äî‚Äî‚Äî –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∏–∫—Å–µ–ª—è ‚Äî‚Äî‚Äî
    function savePixel(x, y, color) {
      if (!currentUID) return;
      const key = `${x}_${y}`;
      db.ref('pixels/' + key).set({
        x, y, color,
        uid: currentUID
      });
    }

    // ‚Äî‚Äî‚Äî –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞–Ω–≤–∞—Å—É ‚Äî‚Äî‚Äî
    canvas.addEventListener('click', e => {
      if(!currentUser) return alert("–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∏—Å–æ–≤–∞—Ç—å");

      // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–∞–Ω–≤–∞—Å–∞
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      let x = Math.floor((e.clientX - rect.left) * scaleX);
      let y = Math.floor((e.clientY - rect.top) * scaleY);

      // –í—ã–±–∏—Ä–∞–µ–º —Ü–≤–µ—Ç (–¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã —Ñ–∏–∫—Å–∏—Ä—É–µ–º)
      const color = prompt("–í–≤–µ–¥–∏—Ç–µ —Ü–≤–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, #f00 –∏–ª–∏ red):", "#ff0000");
      if(!color) return;

      savePixel(x, y, color);
      drawGrid();
    });

    // ‚Äî‚Äî‚Äî –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ‚Äî‚Äî‚Äî
    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    };
    logoutBtn.onclick = () => auth.signOut();

    auth.onAuthStateChanged(user => {
      if(user) {
        currentUser = user;
        currentUID = user.uid;
        userInfo.textContent = `üë§ ${user.displayName}`;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline';
        ownerLabel.style.display = (currentUID === OWNER_UID) ? 'inline' : 'none';

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∏–∫
        db.ref(`users/${currentUID}/nickname`).once('value').then(snap => {
          if(snap.exists()) {
            nicknameInput.value = snap.val();
          } else {
            nicknameInput.value = '';
          }
        });

        drawGrid();
      } else {
        currentUser = null;
        currentUID = null;
        userInfo.textContent = '';
        loginBtn.style.display = 'inline';
        logoutBtn.style.display = 'none';
        nicknameInput.value = '';
        ownerLabel.style.display = 'none';
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        leaderboardDiv.textContent = '–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ç–æ–ø –∏–≥—Ä–æ–∫–æ–≤';
      }
    });

    // ‚Äî‚Äî‚Äî –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∏–∫–∞ ‚Äî‚Äî‚Äî
    saveNickBtn.onclick = () => {
      if(!currentUID) return alert('–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∏–∫');
      const nick = nicknameInput.value.trim();
      if(nick.length > 0) {
        db.ref(`users/${currentUID}`).update({ nickname: nick });
        alert('–ù–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
      }
    };
