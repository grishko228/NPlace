<!DOCTYPE html><html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NPLACE</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
    <style>
      * { box-sizing: border-box; }
      body {
        font-family: 'Segoe UI', sans-serif;
        margin: 0;
        background: #121212;
        color: #fff;
        padding: 1rem;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
      }
      button {
        background: #1f1f1f;
        color: white;
        border: 1px solid #444;
        padding: 0.5rem 1rem;
        cursor: pointer;
        border-radius: 5px;
      }
      button:hover {
        background: #333;
      }
      #canvas {
        border: 1px solid #444;
        background: #fff;
        image-rendering: pixelated;
        display: block;
        margin: 1rem 0;
      }
      #nickname-section input {
        padding: 0.5rem;
        border-radius: 4px;
        border: none;
        width: 200px;
        margin-right: 0.5rem;
      }
      .panel {
        background: #1e1e1e;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
      }
      .leaderboard-entry {
        display: flex;
        justify-content: space-between;
        padding: 0.25rem 0;
        border-bottom: 1px solid #333;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>NPLACE</h1>
      <div>
        <button id="login">üîê –í–æ–π—Ç–∏</button>
        <button id="logout" style="display: none">üö™ –í—ã–π—Ç–∏</button>
      </div>
    </header><section id="nickname-section" class="panel" style="display: none">
  <label for="nickname">–ù–∏–∫–Ω–µ–π–º:</label>
  <input type="text" id="nickname" placeholder="–í–∞—à –Ω–∏–∫..." />
  <button id="saveNick">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <span id="ownerLabel" style="display: none">üëë –í–ª–∞–¥–µ–ª–µ—Ü</span>
</section>

<canvas id="canvas" width="50" height="50"></canvas>

<section class="panel">
  <h2>üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h2>
  <div id="leaderboard">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</section>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCVwOQaTPRrDz3dC98Tyg3ByW0JbyNLMJY",
    authDomain: "analox-wplase.firebaseapp.com",
    databaseURL: "https://analox-wplase-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "analox-wplase",
    storageBucket: "analox-wplase.appspot.com",
    messagingSenderId: "839969323587",
    appId: "1:839969323587:web:3c476167862cac9d32b2f6"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const loginBtn = document.getElementById('login');
  const logoutBtn = document.getElementById('logout');
  const nicknameSection = document.getElementById('nickname-section');
  const nicknameInput = document.getElementById('nickname');
  const saveNickBtn = document.getElementById('saveNick');
  const ownerLabel = document.getElementById('ownerLabel');
  const leaderboardDiv = document.getElementById('leaderboard');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  const OWNER_UID = "–í–°–¢–ê–í–¨_–°–í–û–ô_UID_–°–Æ–î–ê";
  let currentUser = null;
  let currentUID = null;

  function drawGrid() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    db.ref('pixels').once('value').then(snapshot => {
      snapshot.forEach(child => {
        const p = child.val();
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, 1, 1);
      });
    });
  }

  function updateLeaderboard() {
    db.ref('pixels').once('value').then(snapshot => {
      const counts = {};
      snapshot.forEach(child => {
        const { uid } = child.val();
        counts[uid] = (counts[uid] || 0) + 1;
      });

      const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
      leaderboardDiv.innerHTML = sorted.map(([uid, count]) => {
        return `<div class="leaderboard-entry"><span>${uid.slice(0,6)}...</span><span>${count}</span></div>`;
      }).join('');
    });
  }

  canvas.addEventListener('click', e => {
    if (!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞');

    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) * (canvas.width / rect.width));
    const y = Math.floor((e.clientY - rect.top) * (canvas.height / rect.height));
    const color = prompt("–¶–≤–µ—Ç (#hex –∏–ª–∏ red):", "#ff0000");
    if (!color) return;

    const key = `${x}_${y}`;
    db.ref('pixels/' + key).set({ x, y, color, uid: currentUID });
    drawGrid();
    updateLeaderboard();
  });

  loginBtn.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider);
  };

  logoutBtn.onclick = () => auth.signOut();

  saveNickBtn.onclick = () => {
    if (!currentUID) return;
    const nick = nicknameInput.value.trim();
    db.ref(`users/${currentUID}/nickname`).set(nick);
  };

  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      currentUID = user.uid;

      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'inline';
      nicknameSection.style.display = 'block';

      if (currentUID === OWNER_UID) {
        ownerLabel.style.display = 'inline';
      }

      db.ref(`users/${currentUID}/nickname`).once('value').then(snap => {
        if (snap.exists()) nicknameInput.value = snap.val();
      });

      drawGrid();
      updateLeaderboard();
    } else {
      currentUser = null;
      currentUID = null;
      loginBtn.style.display = 'inline';
      logoutBtn.style.display = 'none';
      nicknameSection.style.display = 'none';
    }
  });
</script>

  </body>
</html>
