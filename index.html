<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NPLACE ‚Äî —Ç–≤–æ–π —Ö–æ–ª—Å—Ç</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; background: #f0f0f0; }
    h1 { margin-bottom: 0.2em; }
    #auth { margin-bottom: 15px; }
    #login, #logout { padding: 8px 15px; font-size: 14px; cursor: pointer; }
    #logout { display: none; }
    #user-info { margin-left: 10px; font-weight: bold; }
    #nickname-section { margin-bottom: 20px; }
    #nickname { width: 200px; padding: 6px; font-size: 14px; }
    #saveNick { padding: 6px 12px; margin-left: 6px; cursor: pointer; }
    #leaderboard { background: white; padding: 10px; border-radius: 5px; max-width: 300px; }
    .top-player { padding: 4px 0; border-bottom: 1px solid #ddd; }
    .top-player:last-child { border-bottom: none; }
    #canvas-container { position: relative; margin-top: 20px; }
    canvas { background: white; border: 1px solid #aaa; image-rendering: pixelated; cursor: crosshair; }
    #scaleControl { margin-top: 10px; }
    #scaleControl button { margin-right: 5px; cursor: pointer; padding: 5px 10px; }
    .owner-label { color: green; font-weight: bold; margin-left: 8px; }
  </style>
</head>
<body>
  <h1>NPLACE</h1>

  <div id="auth">
    <button id="login">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    <button id="logout">–í—ã–π—Ç–∏</button>
    <span id="user-info"></span>
  </div>

  <div id="nickname-section">
    <label for="nickname">–ù–∏–∫: </label>
    <input type="text" id="nickname" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫" />
    <button id="saveNick">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <span id="ownerLabel" class="owner-label" style="display:none;">üëë –í–ª–∞–¥–µ–ª–µ—Ü</span>
  </div>

  <h2>üèÜ –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h2>
  <div id="leaderboard">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

  <div id="canvas-container">
    <canvas id="canvas" width="50" height="50"></canvas>
  </div>

  <div id="scaleControl">
    –ú–∞—Å—à—Ç–∞–±: 
    <button data-scale="1">1x</button>
    <button data-scale="2">2x</button>
    <button data-scale="4">4x</button>
    <button data-scale="8" class="active">8x</button>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCVwOQaTPRrDz3dC98Tyg3ByW0JbyNLMJY",
      authDomain: "analox-wplase.firebaseapp.com",
      databaseURL: "https://analox-wplase-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "analox-wplase",
      storageBucket: "analox-wplase.appspot.com",
      messagingSenderId: "839969323587",
      appId: "1:839969323587:web:3c476167862cac9d32b2f6"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const loginBtn = document.getElementById('login');
    const logoutBtn = document.getElementById('logout');
    const userInfo = document.getElementById('user-info');
    const nicknameInput = document.getElementById('nickname');
    const saveNickBtn = document.getElementById('saveNick');
    const ownerLabel = document.getElementById('ownerLabel');
    const leaderboardDiv = document.getElementById('leaderboard');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const scaleButtons = document.querySelectorAll('#scaleControl button');

    const OWNER_UID = "—Ç–≤–æ—è_—Ñ–∏—Ä–µ–±–µ–π—Å_uid_—Å—é–¥–∞_–≤—Å—Ç–∞–≤—å"; // –í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ–π uid –≤–ª–∞–¥–µ–ª—å—Ü–∞

    let currentUser = null;
    let currentUID = null;
    let scale = 8; // –Ω–∞—á–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–±
    const baseSize = 50;

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∞—Å—à—Ç–∞–±–∞
    function setScale(newScale) {
      scale = newScale;
      canvas.style.width = baseSize * scale + 'px';
      canvas.style.height = baseSize * scale + 'px';
      scaleButtons.forEach(btn => btn.classList.remove('active'));
      document.querySelector(`#scaleControl button[data-scale='${scale}']`).classList.add('active');
    }

    setScale(scale);

    // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É –∏ –ø–∏–∫—Å–µ–ª–∏
    function drawCanvas() {
      ctx.clearRect(0, 0, baseSize, baseSize);
      db.ref('pixels').once('value').then(snapshot => {
        snapshot.forEach(child => {
          const p = child.val();
          if (p.x !== undefined && p.y !== undefined && p.color) {
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, 1, 1);
          }
        });
      }).then(() => {
        // –°–µ—Ç–∫–∞
        ctx.strokeStyle = '#ccc';
        ctx.lineWidth = 0.1;
        for (let i = 0; i <= baseSize; i++) {
          ctx.beginPath();
          ctx.moveTo(i, 0);
          ctx.lineTo(i, baseSize);
          ctx.stroke();

          ctx.beginPath();
          ctx.moveTo(0, i);
          ctx.lineTo(baseSize, i);
          ctx.stroke();
        }
      });
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∏–∫—Å–µ–ª—è
    function savePixel(x, y, color) {
      if (!currentUID) return;
      const key = `${x}_${y}`;
      db.ref('pixels/' + key).set({ x, y, color, uid: currentUID });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞–Ω–≤–∞—Å–µ
    canvas.addEventListener('click', e => {
      if (!currentUser) return alert("–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∏—Å–æ–≤–∞—Ç—å");

      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const x = Math.floor((e.clientX - rect.left) * scaleX);
      const y = Math.floor((e.clientY - rect.top) * scaleY);

      const color = prompt("–í–≤–µ–¥–∏—Ç–µ —Ü–≤–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, #f00 –∏–ª–∏ red):", "#ff0000");
      if (!color) return;

      savePixel(x, y, color);
      drawCanvas();
      updateLeaderboard();
    });

    // –õ–æ–≥–∏–Ω/–ª–æ–≥–∞—É—Ç
    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    };

    logoutBtn.onclick = () => auth.signOut();

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        currentUID = user.uid;
        userInfo.textContent = `üë§ ${user.displayName}`;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline';
        ownerLabel.style.display = (currentUID === OWNER_UID) ? 'inline' : 'none';

        db.ref(`users/${currentUID}/nickname`).once('value').then(snap => {
          nicknameInput.value = snap.exists() ? snap.val() : '';
        });

        drawCanvas();
        updateLeaderboard();
      } else {
        currentUser = null;
        currentUID = null;
        userInfo.textContent = '';
        loginBtn.style.display = 'inline';
        logoutBtn.style.display = 'none';
        nicknameInput.value = '';
        ownerLabel.style.display = 'none';
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        leaderboardDiv.textContent = '–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ç–æ–ø –∏–≥—Ä–æ–∫–æ–≤';
      }
    });

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∏–∫–∞
    saveNickBtn.onclick = () => {
      if (!currentUID) return alert('–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∏–∫');
      const nick = nicknameInput.value.trim();
      if (nick.length > 0) {
        db.ref(`users/${currentUID}`).update({ nickname: nick });
        alert('–ù–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
      }
    };

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ø–∞
    function updateLeaderboard() {
      db.ref('pixels').once('value').then(snapshot => {
        const counts = {};
        snapshot.forEach(child => {
          const p = child.val();
          if (p.uid) counts[p.uid] = (counts[p.uid] || 0) + 1;
        });

        const promises = Object.entries
